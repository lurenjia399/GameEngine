# 贴图

## 1 法线贴图

1. 法线的空间变换

   我们在进行光照计算的时候，就会用到法线，这里我们也需要将模型空间下的法线转换到世界空间下，模型顶点的转换就用顶点坐标乘上obiect2world矩阵就行，但是法线就需要乘上object2world的逆转置矩阵，这是为什么？

   ​	回答1：形象理解上，法线是垂直于切线的向量，当切线以不成比例缩放的时候，就会影响法线的方向，法线如果按照相同变换那么其将不会与平面继续保持垂直。法线这时候就需要按照反方向变换，也就是需要object2world的逆。object2world矩阵中包含缩放，旋转，平移的信息，法线是向量所以将平移舍去变为（3X3矩阵），所以我们求逆的时候得到了缩放，旋转矩阵的逆，这时候得到的矩阵里面旋转也变成了逆，不是我们想要的（因为旋转不会影响法线方向），旋转矩阵又为正交矩阵（转置等于逆），所以很自然的转置就得到了缩放矩阵的逆转置和旋转矩阵。也就是world2object矩阵中包含了缩放矩阵的逆转置和旋转矩阵，也就是当不是等比例缩放的时候，我们的法线需要乘object2world的逆转置矩阵。

   ​	回答2：不严谨的数学计算上，法线是垂直于切线的向量，也就是 n * t = 0 ，法线点乘切线等于0，我们模拟切线乘上矩阵A，法线乘上矩阵B，公式就变成了

   Bn * At = 0。乘号两边同乘矩阵A的逆得A-1Bn * t = 0，要想等式成立，即A-1B = 1(单位向量)，也就是矩阵A是矩阵B得逆变换，也就是法线在进行空间变换得时候需要乘上切线变换矩阵得逆变换矩阵。

2. 什么是法线贴图呢，贴图里面存储了什么？

   1 我们渲染一个模型，可以给每个顶点法向量来让其进行光照等计算，但是模型顶点数量的增多，也会导致计算压力过大，所以我们就可以仿照纹理贴图的形式，搞一个法线贴图来存储每个采样点得法线偏移，通过每个点得实际法线吗，在添加上法线贴图的偏移，就是最终用于计算光照等信息的法线。法线贴图也是用rgb三种颜色来代替法向xyz，如果rgb颜色值直接与法向量一一对应，那么模型只要改变，或者说是模型与贴图不匹配，计算出的法向量就会有问题，并且立方体有六个面就需要六张法线贴图。所以为了通用性，我们将从rgb中读取的颜色值代表法线偏移放在切线空间，在通过tbn矩阵将其变换到世界空间下，就能准确得出，此时采样点的法向量。

   2 我们拿一个墙面举例，如果我们只用纹理贴图，那么这个墙面看起来就会很光滑没有那种凹凸的表现，而凹凸表现一般都是通过光照来体现，进一步就是法线影响的，我们在创建这个墙面的时候会赋予每个三角形网格顶点法线，然后三角形网格中的法线都是通过插值来得到，因为这是个墙面也就是个平面所以法线都是一个值，自然就不会有那种凹凸的感觉。所以我们在插值得到法线之后，在基于这个法线赋予其一个偏移不就可以改变法线进而得到凹凸的效果，而这个偏移我们就存储在了贴图中，也就是法线贴图。

3. 什么是切线空间呢？

   一个空间就是要找到组成这个空间的3个基向量，切线空间是位于三角形表面之上的空间，xyz轴分别为t轴（切线方向）,b轴（负切线方向），n轴（法线方向）,设定切线空间的z轴和法线同向，那么x,y轴呢？曲面上的某点切线有无数条，共同组成了切平面，所以规定了一套固定的x,y轴，也就是uv展开方向相同的那个方向作为切线方向（屏幕左下角原点，向右是切线方向，向上是负切线方向）。

4. 为什么要有切线空间，切线空间好处？

   1 模型空间：

   优点：好理解，简单直观

   缺点：如果模型顶点发生改变，那么贴图也要随之改变

   2 切线空间

   优点：

   此空间下存储的是相对法线信息，因此换个网格应用该纹理，也能得到相应的效果。

   可以进行uv动画，通过移动该纹理的uv坐标实现凹凸移动的效果。

   可以复用，相同模型都可以用这一张纹理

   可以压缩，贴图中存储的都是归一化后的值，所以就可以只存储xy方向，从而推导出z方向（三维归一化之后点组成的空间就是单位球，xy组成的是平面，平面和球有四个交点，有两个是xy反方向交点舍去，再把z为负的交点舍去，自然就剩下一个交点也就是z值了）

5. 为什么法线贴图偏蓝呢？

   贴图中存储的都是原法线的偏移量，并且用归一化后的向量表示，也就是范围是[-1.1]而贴图中rgb颜色能够表示的范围是[0,1]，所以需要进行一个( x + 1) / 2的转换。当法线没有偏移的时候取值2为（0，0，1）转换后贴图中存储的是（0.5，0.5，1）也就是偏蓝色了。

6. TBN矩阵

   TBN矩阵定义了一个点从切线空间变换到世界空间或者模型空间的变换矩阵：当N是模型空间中的法线时，计算出的TBN是切线空间转模型空间矩阵，若N是世界空间中的法线时，计算出的TBN是切线空间转世界空间矩阵。

   我处理的方式就是，通过将模型的顶点数据（顶点位置，顶点法线，uv坐标，切线方向）传给顶点着色器，通过转到世界空间和T X N = B，进而得到TBN矩阵，传到片元着色器，然后 TBN X Normal得到最终的法线进而计算光照等信息。

   需要注意的是：TBN矩阵中的N是原法线（也就是模型顶点的真实法线），而Normal是从法线贴图中提取出来然后经过转换的法线，相乘得出的才是真正应该计算光照等信息的法线。

7. 具体如何实现呢？

   每个顶点结构需要在位置，法向（此时的法向不用来计算光照，只是用来计算tbn矩阵）的基础上增加一个切向量t(tangent)，也就是用来计算tbn矩阵。

   切线空间是由法向（Z）、Tangent（切线t）、bitangent（切线b）三个向量组成。我们在顶点着色器中获取Z和t以及b(z和t叉乘)来构建tbn矩阵，再将tbn矩阵传入片元着色器。

   在片元着色器中采样获取到法线贴图中的rgb颜色（贴图中的范围是[0, 1]，而切线空间的范围是[-1, 1]）然后进行映射x * 2 - 1 获取到切线空间中的法向量，然后将其乘tbn矩阵，也就是从切线空间转换到了世界空间，以便后续光照等信息的计算。
