# 微表面模型

![image-20231105215728212](F:\learn\GameEngine\image\image-20231105215728212.png)

从远处看模型表面是平面，粗糙的，也就是macrosurface

近处看模型表面是凹凸不平的，并且每个表面微元看作是镜面反射

微平面的镜面反射集中就表现为光滑点，不集中就表现为粗糙点

![image-20231105220200383](F:\learn\GameEngine\image\image-20231105220200383.png)

# Cook-Torrance BRDF

现在已经有很好几种BRDF都能近似的得出物体表面对于光的反应，但是几乎所有实时渲染管线使用的都是一种被称为Cook-Torrance BRDF模型

Cook-Torrance BRDF兼有漫反射和镜面反射两个部分：

![image-20231105220545984](F:\learn\GameEngine\image\image-20231105220545984.png)

这里的kd是早先提到过的入射光线中**被折射**部分的能量所占的比率，而ks是**被反射**部分的比率。

其中漫反射项为，

![image-20231105222336472](F:\learn\GameEngine\image\image-20231105222336472.png)

漫反射项的形式简单且比较容易理解，但是对于镜面反射项，其形式则要更加高级一点，

![image-20231105222405250](F:\learn\GameEngine\image\image-20231105222405250.png)

看起来确实有些唬人，但是不要急，让我们先简单的解释一下式子当中各项参数，之和再一步步的进行详细阐述： 其中v为反射方向(观察方向)，l为入射方向，n为**宏观表面法向**，ℎ为**微平面法向**

分子上的D,F,G为3个不同的函数：

**函数D：法线分布函数(Normal Distribution Function)，其代表了所有微观角度下微小镜面法线的分布情况，粗糙表面法线分布相对均匀，光滑表面法线分布相对集中 (这种解释可能会有些抽象，后面会给出更加直观的物理上的解释)**

**函数G：几何函数(Geometry Function)，描述了微平面自遮挡的属性。当一个平面相对比较粗糙的时候，平面表面上的微平面有可能挡住其他的微平面从而减少表面所反射的光线。**

**函数F：菲涅尔方程(Fresnel Rquation)，描述了物体表面在不同入射光角度下反射光线所占的比率**

F和G都是因为入射光线角度不同导致的，因此先假设没有光线会为上述两个函数产生损失（即二者都=1），方便我们进行BRDF推导

![image-20231105222716721](F:\learn\GameEngine\image\image-20231105222716721.png)

上图中红色的面积表示了D函数的物理意义，推导就通过笔记给出

![image-20231105222842055](F:\learn\GameEngine\image\image-20231105222842055.png)

注意其中左侧求解比值的时候 是怎么算的

# **菲涅尔方程F**

菲涅尔方程是为了描述物理世界当中，观察角度与法线夹角越大反射程度一般越大的一种情形，但是精确计算计算消耗较大，一般用Fresnel-Schlick近似法求得近似解

![image-20231105224157322](F:\learn\GameEngine\image\image-20231105224157322.png)

F0表示平面的基础反射率，它是利用所谓折射系数(Indices of Refraction)计算得出的,如何精确计算出呢？

![image-20231105224405286](F:\learn\GameEngine\image\image-20231105224405286.png)

涉及了大量的计算，所以我们都用近似结果

![image-20231105224440343](F:\learn\GameEngine\image\image-20231105224440343.png)

直接就用两个折射率算得了

# **3.3.2几何函数**G

几何函数G是为了表示微平面的自遮挡从而引起的光线损失，一般会出现如下两种的遮挡情况

![image-20231105224546436](F:\learn\GameEngine\image\image-20231105224546436.png)

左边一幅图中是入射光线无法照射到一些微平面，这种情况称为Shadowing，右边图中是反射光线无法正常到达人眼，称为Masking，而几何函数G正是为了模拟出这两种情况所导致的光线所示，在UE4中采用了Schlick-GGX来进行建模：

![image-20231105224608093](F:\learn\GameEngine\image\image-20231105224608093.png)

一般来说表面粗糙程度Roughness越大，遮挡程度越大